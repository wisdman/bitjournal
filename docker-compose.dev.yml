version: '3.3'

services:

  db:
    restart: unless-stopped
    image: postgres:10-alpine
    volumes:
      - data-volume:/var/lib/postgresql/data
      - ./sql/postgresql.conf:/etc/postgresql.conf:ro
      - ./sql/initdb.d:/docker-entrypoint-initdb.d:ro
    environment:
      POSTGRES_DB: bitjournal
      POSTGRES_USER: bitjournal
      POSTGRES_PASSWORD: bitjournal
    networks:
      default:
    command: postgres -c config_file=/etc/postgresql.conf

  api-main-a:
    restart: unless-stopped
    build:
      context: ./api
      dockerfile: Dockerfile.main
    links:
      - db
    depends_on:
      - db
    env_file:
      - ./api/environment
    environment:
      NODE_DEBUG: service
    networks:
      default:

  api-ticker-a:
    restart: unless-stopped
    build:
      context: ./api
      dockerfile: Dockerfile.ticker
    links:
      - db
    depends_on:
      - db
    env_file:
      - ./api/environment
    environment:
      NODE_DEBUG: service
    networks:
      default:

  api-raw-a:
    restart: unless-stopped
    build:
      context: ./api
      dockerfile: Dockerfile.raw
    links:
      - db
    depends_on:
      - db
    env_file:
      - ./api/environment
    environment:
      NODE_DEBUG: service
    networks:
      default:

  api-front:
    restart: unless-stopped
    build: ./nginx
    links:
      - api-main-a
      - api-ticker-a
      - api-raw-a
    depends_on:
      - api-main-a
      - api-ticker-a
      - api-raw-a
    volumes:
      - ./api/assets:/www:ro
      - ./api/server.conf.d:/etc/nginx/server.conf.d:ro
      - ./api/server.dev.conf:/etc/nginx/server.conf:ro
      - ./api/dev-ssl/fullchain.pem:/etc/nginx/fullchain.pem:ro
      - ./api/dev-ssl/privkey.pem:/etc/nginx/privkey.pem:ro
    networks:
      default:
    ports:
      - 4434:443

  raw-back-a:
    restart: unless-stopped
    build:
      context: ./raw
      dockerfile: Dockerfile.main
    links:
      - db
    depends_on:
      - db
    env_file:
      - ./raw/environment
    environment:
      NODE_DEBUG: service
    networks:
      default:

  raw-front:
    restart: unless-stopped
    build: ./nginx
    links:
      - raw-a
    depends_on:
      - raw-a
    volumes:
      - ./raw/assets:/www:ro
      - ./raw/raw.conf:/etc/nginx/raw.conf:ro
      - ./raw/server.dev.conf:/etc/nginx/server.conf:ro
      - ./raw/dev-ssl/fullchain.pem:/etc/nginx/fullchain.pem:ro
      - ./raw/dev-ssl/privkey.pem:/etc/nginx/privkey.pem:ro
    networks:
      default:
    ports:
      - 4435:443

  admin:
    restart: unless-stopped
    build: ./nginx
    volumes:
      - ./admin/dist:/www:ro
      - ./admin/server.conf:/etc/nginx/server.conf:ro
      - ./admin/dev-ssl/fullchain.pem:/etc/nginx/fullchain.pem:ro
      - ./admin/dev-ssl/privkey.pem:/etc/nginx/privkey.pem:ro
      - ./admin/ssl/ca.crt:/etc/nginx/ca.crt:ro
    networks:
      default:
    ports:
      - 4433:443

  portal-back-a:
    restart: unless-stopped
    build:
      context: ./portal
      dockerfile: Dockerfile.back
    environment:
      NODE_DEBUG: service
    networks:
      default:

  portal-front:
    restart: unless-stopped
    build: ./nginx
    links:
      - portal-back-a
    depends_on:
      - portal-back-a
    volumes:
      - ./portal/dist/front:/www:ro
      - ./portal/server.conf:/etc/nginx/server.conf:ro
      - ./portal/dev-ssl/fullchain.pem:/etc/nginx/fullchain.pem:ro
      - ./portal/dev-ssl/privkey.pem:/etc/nginx/privkey.pem:ro
    networks:
      default:
    ports:
      - 80:80
      - 443:443

volumes:
  data-volume:
